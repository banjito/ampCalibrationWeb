<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login | AMP Calibration</title>
  <link rel="icon" type="image/svg+xml" href="img/icon/icon01.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="config.js"></script>
  <script src="auth.js" defer></script>
  <script src="sidebar.js" defer></script>
</head>
<body class="bg-gray-100">
  
  <!-- Include Global Sidebar -->
  <div id="sidebarContainer"></div>
  <script>
    (function() {
      fetch('sidebar.html')
        .then(response => response.text())
        .then(html => {
          const container = document.getElementById('sidebarContainer');
          if (container) {
            container.innerHTML = html;
            requestAnimationFrame(() => {
              if (typeof initSidebar === 'function') {
                initSidebar();
              } else {
                setTimeout(() => {
                  if (typeof initSidebar === 'function') {
                    initSidebar();
                  }
                }, 100);
              }
            });
          }
        })
        .catch(error => {
          console.error('Error loading sidebar:', error);
        });
    })();
  </script>

  <!-- Header -->
  <header class="bg-green py-4">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between">
        <!-- Logo and Sidebar Toggle -->
        <div class="flex items-center gap-4">
          <button
            type="button" onclick="document.dispatchEvent(new CustomEvent('basecoat:sidebar'))"
            class="text-white hover:opacity-80 transition-opacity p-2"
            aria-label="Toggle sidebar"
          >
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
          <a href="index.html" class="header-logo-link">
            <img src="img/logo/header.svg" alt="AMP Calibration" class="header-logo">
          </a>
        </div>
        
        <!-- Navigation -->
        <nav class="flex items-center gap-4">
          <a href="index.html" class="text-white text-sm font-semibold header-nav-link">HOME</a>
          <span class="text-white opacity-40">|</span>
          <a href="jobs.html" class="text-white text-sm font-semibold header-nav-link">JOBS</a>
          <span class="text-white opacity-40">|</span>
          <a href="services.html" class="text-white text-sm font-semibold header-nav-link">SERVICES</a>
          <span class="text-white opacity-40">|</span>
          <a href="about.html" class="text-white text-sm font-semibold header-nav-link">ABOUT</a>
          <span class="text-white opacity-40">|</span>
          <a href="contact.html" class="text-white text-sm font-semibold border border-white rounded px-4 py-2 header-nav-button header-nav-home">CONTACT US</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Login Section -->
  <section class="min-h-screen flex items-center justify-center py-20">
    <div class="container mx-auto px-4">
      <div class="max-w-md mx-auto">
        <!-- Login Card -->
        <div class="bg-green border-2 border-white rounded-lg shadow-lg p-8 sm:p-12">
          <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2 font-horizon">LOGIN</h1>
            <p class="text-white/80 font-raleway-light" id="subtitleText">Sign in with your email and 6-digit PIN</p>
          </div>

          <form id="authForm" class="space-y-6">
            <div>
              <label for="email" class="block text-white text-sm font-semibold mb-2 font-benzin">
                EMAIL ADDRESS
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                placeholder="your@email.com"
                class="w-full bg-white/10 border-2 border-white/50 rounded-lg px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:border-white focus:bg-white/20 transition-colors font-cm-geom"
                autocomplete="email"
              />
            </div>

            <div id="confirmEmailGroup" class="hidden">
              <label for="confirmEmail" class="block text-white text-sm font-semibold mb-2 font-benzin">
                CONFIRM EMAIL ADDRESS
              </label>
              <input
                type="email"
                id="confirmEmail"
                name="confirmEmail"
                placeholder="repeat your@email.com"
                class="w-full bg-white/10 border-2 border-white/50 rounded-lg px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:border-white focus:bg-white/20 transition-colors font-cm-geom"
                autocomplete="email"
              />
            </div>

            <div>
              <label for="pin" class="block text-white text-sm font-semibold mb-2 font-benzin">
                6-DIGIT PIN
              </label>
              <input
                type="password"
                id="pin"
                name="pin"
                maxlength="6"
                inputmode="numeric"
                pattern="[0-9]{6}"
                placeholder="••••••"
                class="w-full bg-white/10 border-2 border-white/50 rounded-lg px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:border-white focus:bg-white/20 transition-colors font-cm-geom tracking-widest text-center"
                autocomplete="current-password"
              />
            </div>

            <div id="confirmPinGroup" class="hidden">
              <label for="confirmPin" class="block text-white text-sm font-semibold mb-2 font-benzin">
                CONFIRM PIN
              </label>
              <input
                type="password"
                id="confirmPin"
                name="confirmPin"
                maxlength="6"
                inputmode="numeric"
                pattern="[0-9]{6}"
                placeholder="••••••"
                class="w-full bg-white/10 border-2 border-white/50 rounded-lg px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:border-white focus:bg-white/20 transition-colors font-cm-geom tracking-widest text-center"
                autocomplete="new-password"
              />
            </div>

            <div id="message" class="hidden text-sm font-raleway-light"></div>

            <button
              type="submit"
              id="submitBtn"
              class="w-full border-2 border-white text-white px-8 py-3 rounded-full hover:bg-white hover:text-green transition-colors font-medium tracking-wide font-benzin disabled:opacity-50 disabled:cursor-not-allowed"
            >
              SIGN IN
            </button>
          </form>

          <div class="mt-6 text-center space-y-2">
            <p class="text-white/70 text-sm font-raleway-light" id="infoText">
              Don't have an account yet? Create one with a 6-digit PIN.
            </p>
            <button
              type="button"
              id="toggleModeBtn"
              class="text-white font-semibold underline-offset-4 hover:underline"
            >
              Create an account
            </button>
          </div>
        </div>

        <!-- Back to Home -->
        <div class="mt-6 text-center">
          <a href="index.html" class="text-green hover:opacity-80 transition-opacity font-semibold">
            ← Back to Home
          </a>
        </div>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('authForm');
      const messageDiv = document.getElementById('message');
      const submitBtn = document.getElementById('submitBtn');
      const emailInput = document.getElementById('email');
      const confirmEmailGroup = document.getElementById('confirmEmailGroup');
      const confirmEmailInput = document.getElementById('confirmEmail');
      const pinInput = document.getElementById('pin');
      const confirmPinGroup = document.getElementById('confirmPinGroup');
      const confirmPinInput = document.getElementById('confirmPin');
      const subtitleText = document.getElementById('subtitleText');
      const infoText = document.getElementById('infoText');
      const toggleModeBtn = document.getElementById('toggleModeBtn');

      let mode = 'login';

      const enforceDigits = (input) => {
        if (!input) return;
        input.addEventListener('input', (event) => {
          const cleaned = event.target.value.replace(/\D/g, '').slice(0, 6);
          event.target.value = cleaned;
        });
      };

      enforceDigits(pinInput);
      enforceDigits(confirmPinInput);

      const showMessage = (text, type) => {
        messageDiv.textContent = text;
        messageDiv.className = `text-sm font-raleway-light ${type === 'error' ? 'text-red-200' : 'text-green-200'}`;
        messageDiv.classList.remove('hidden');
      };

      const setSubmitting = (isSubmitting, processingText) => {
        submitBtn.disabled = isSubmitting;
        submitBtn.textContent = isSubmitting
          ? processingText
          : (mode === 'login' ? 'SIGN IN' : 'CREATE ACCOUNT');
      };

      const setMode = (nextMode, options = {}) => {
        const { preserveMessage = false } = options;

        mode = nextMode;
        const isLogin = mode === 'login';

        subtitleText.textContent = isLogin
          ? 'Sign in with your email and 6-digit PIN'
          : 'Create your account and set a 6-digit PIN';

        infoText.textContent = isLogin
          ? "Don't have an account yet? Create one with a 6-digit PIN."
          : 'Already have an account? Sign in with your 6-digit PIN.';

        confirmEmailGroup.classList.toggle('hidden', isLogin);
        confirmPinGroup.classList.toggle('hidden', isLogin);

        submitBtn.textContent = isLogin ? 'SIGN IN' : 'CREATE ACCOUNT';
        toggleModeBtn.textContent = isLogin ? 'Create an account' : 'Back to sign in';

        if (!preserveMessage) {
          messageDiv.classList.add('hidden');
          messageDiv.textContent = '';
        }

        confirmEmailInput.value = '';
        confirmPinInput.value = '';
        pinInput.value = '';
        submitBtn.disabled = false;

        setTimeout(() => {
          emailInput.focus();
        }, 50);
      };

      toggleModeBtn.addEventListener('click', () => {
        setMode(mode === 'login' ? 'create' : 'login');
      });

      getCurrentUser().then(result => {
        if (result.user && !result.error) {
          window.location.href = '/';
        }
      });

      setupAuthStateListener((session) => {
        if (session) {
          window.location.href = '/';
        }
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const email = emailInput.value.trim();
        const pin = pinInput.value.trim();

        if (!email) {
          showMessage('Please enter your email address', 'error');
          return;
        }

        if (!/^[0-9]{6}$/.test(pin)) {
          showMessage('PIN must be exactly 6 digits', 'error');
          return;
        }

        if (mode === 'create') {
          const confirmEmail = (confirmEmailInput.value || '').trim();
          const confirmPin = (confirmPinInput.value || '').trim();

          if (!confirmEmail) {
            showMessage('Please confirm your email address', 'error');
            return;
          }

          if (email.toLowerCase() !== confirmEmail.toLowerCase()) {
            showMessage('Email addresses do not match', 'error');
            return;
          }

          if (!/^[0-9]{6}$/.test(confirmPin)) {
            showMessage('Confirm PIN must be exactly 6 digits', 'error');
            return;
          }

          if (pin !== confirmPin) {
            showMessage('PIN values do not match', 'error');
            return;
          }
        }

        setSubmitting(true, mode === 'login' ? 'SIGNING IN...' : 'CREATING ACCOUNT...');

        if (mode === 'login') {
          const result = await loginWithPin(email, pin);

          if (result.success) {
            showMessage('PIN verified! Redirecting...', 'success');
            setTimeout(async () => {
              const userCheck = await getCurrentUser();
              if (userCheck.user && !userCheck.error) {
                window.location.href = '/';
              } else {
                setTimeout(() => {
                  window.location.href = '/';
                }, 500);
              }
            }, 300);
          } else {
            const errorText = result.error || 'Failed to sign in. Please try again.';
            const lowerError = errorText.toLowerCase();

            if (lowerError.includes('invalid login credentials')) {
              showMessage('Invalid email or PIN. If you just created an account, make sure you have confirmed your email.', 'error');
            } else {
              showMessage(errorText, 'error');
            }
            setSubmitting(false);
          }
        } else {
          const signupResult = await registerWithPin(email, pin);

          if (!signupResult.success) {
            const errorText = signupResult.error || 'Failed to create account. Please try again.';
            const lowerError = errorText.toLowerCase();

            if (lowerError.includes('already registered')) {
              setMode('login', { preserveMessage: true });
              showMessage('This email already has an account. Please sign in with your PIN.', 'error');
            } else {
              showMessage(errorText, 'error');
            }

            setSubmitting(false);
            return;
          }

          const signupData = signupResult.data || {};
          const requiresEmailConfirmation = !signupData.session && signupData.user && !signupData.user.email_confirmed_at;

          if (requiresEmailConfirmation) {
            setMode('login', { preserveMessage: true });
            showMessage('Account created! Check your email for the confirmation link, then sign in with your PIN.', 'success');
            setSubmitting(false);
            return;
          }

          showMessage('Account created! Signing you in...', 'success');

          const signInResult = await loginWithPin(email, pin);

          if (signInResult.success) {
            setTimeout(async () => {
              const userCheck = await getCurrentUser();
              if (userCheck.user && !userCheck.error) {
                window.location.href = '/';
              } else {
                setTimeout(() => {
                  window.location.href = '/';
                }, 500);
              }
            }, 300);
          } else {
            const errorText = signInResult.error || 'Account created. Please sign in once your email is confirmed.';
            const lowerError = errorText.toLowerCase();
            const requiresConfirmation = lowerError.includes('confirm');

            showMessage(errorText, requiresConfirmation ? 'success' : 'error');
            setSubmitting(false);

            if (requiresConfirmation) {
              setMode('login', { preserveMessage: true });
            }
          }
        }
      });

      setMode('login');
    });
  </script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    lucide.createIcons();
  </script>
</body>
</html>

